{% extends 'main/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - AI Legal Explainer{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trend-indicator {
        font-size: 1.2rem;
        margin-left: 10px;
    }
    
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-stable { color: #6c757d; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .risk-level-badge {
        font-size: 0.8em;
        padding: 4px 8px;
        border-radius: 12px;
        color: white;
    }
    
    .risk-high { background-color: #dc3545; }
    .risk-medium { background-color: #ffc107; color: #212529; }
    .risk-low { background-color: #28a745; }
    
    .language-badge {
        background-color: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        margin: 2px;
        display: inline-block;
    }
    
    .feature-usage-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    
    .feature-usage-item:hover {
        background-color: #e9ecef;
    }
    
    .progress-bar-custom {
        height: 20px;
        background-color: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .progress-success { background-color: #28a745; }
    .progress-warning { background-color: #ffc107; }
    .progress-danger { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-bar"></i> Analytics Dashboard
            </h1>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Analytics Dashboard</strong> provides comprehensive insights into user behavior, 
                document processing patterns, risk analysis trends, and system performance metrics.
            </div>
            
            <!-- Time Period Selector -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock"></i> Analysis Period Selection
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="timePeriod" class="form-label">Analytics Period:</label>
                            <select class="form-select" id="timePeriod" onchange="changeTimePeriod()">
                                {% for period in time_periods %}
                                    <option value="{{ period }}" {% if period == days %}selected{% endif %}>
                                        Last {{ period }} day{% if period != 1 %}s{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-end h-100">
                                <button class="btn btn-primary me-2" onclick="refreshAnalytics()">
                                    <i class="fas fa-sync-alt"></i> Refresh Analytics
                                </button>
                                <button class="btn btn-success" onclick="generateReport()">
                                    <i class="fas fa-file-alt"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Document Processing Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="analytics-card text-center">
                        <div class="metric-value text-primary">{{ analytics.document_analytics.total_documents|default:"0" }}</div>
                        <div class="metric-label">Total Documents</div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="analytics-card text-center">
                        <div class="metric-value text-success">{{ analytics.document_analytics.processed_documents|default:"0" }}</div>
                        <div class="metric-label">Processed Documents</div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="analytics-card text-center">
                        <div class="metric-value text-info">{{ analytics.document_analytics.processing_rate|default:"0" }}%</div>
                        <div class="metric-label">Processing Rate</div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="analytics-card text-center">
                        <div class="metric-value text-warning">{{ analytics.document_analytics.processing_times.avg_time|default:"0"|floatformat:2 }}s</div>
                        <div class="metric-label">Avg Processing Time</div>
                    </div>
                </div>
            </div>
            
            <!-- Language Distribution -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-language"></i> Language Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Document Languages</h6>
                            {% if analytics.language_distribution.language_distribution %}
                                <div class="mb-3">
                                    {% for lang in analytics.language_distribution.language_distribution %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="language-badge">{{ lang.language|upper }}</span>
                                            <span class="badge bg-primary">{{ lang.count }}</span>
                                        </div>
                                        <div class="progress-bar-custom">
                                            <div class="progress-fill progress-success" 
                                                 style="width: {% widthratio lang.count analytics.language_distribution.total_summaries 100 %}%"></div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <p class="text-muted">
                                    <strong>Total Summaries:</strong> {{ analytics.language_distribution.total_summaries }}
                                </p>
                            {% else %}
                                <p class="text-muted">No language data available.</p>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Language Processing Stats</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="analytics-card text-center">
                                        <div class="metric-value text-primary">{{ analytics.language_distribution.language_distribution|length|default:"0" }}</div>
                                        <div class="metric-label">Languages Supported</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="analytics-card text-center">
                                        <div class="metric-value text-success">
                                            {% if analytics.language_distribution.language_distribution %}
                                                {{ analytics.language_distribution.language_distribution.0.language|upper }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </div>
                                        <div class="metric-label">Most Common</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Risk Analysis Patterns -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Risk Analysis Patterns
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Risk Level Distribution</h6>
                            {% if analytics.risk_patterns.risk_distribution %}
                                <div class="mb-3">
                                    {% for risk in analytics.risk_patterns.risk_distribution %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="risk-level-badge risk-{{ risk.risk_level }}">{{ risk.risk_level|title }}</span>
                                            <span class="badge bg-secondary">{{ risk.count }}</span>
                                        </div>
                                        <div class="progress-bar-custom">
                                            <div class="progress-fill 
                                                 {% if risk.risk_level == 'high' %}progress-danger
                                                 {% elif risk.risk_level == 'medium' %}progress-warning
                                                 {% else %}progress-success{% endif %}" 
                                                 style="width: {% widthratio risk.count analytics.risk_patterns.total_clauses 100 %}%"></div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <p class="text-muted">
                                    <strong>Total Clauses:</strong> {{ analytics.risk_patterns.total_clauses }}
                                </p>
                            {% else %}
                                <p class="text-muted">No risk pattern data available.</p>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h6>High-Risk Patterns</h6>
                            {% if analytics.risk_patterns.high_risk_patterns %}
                                <div class="mb-3">
                                    {% for pattern in analytics.risk_patterns.high_risk_patterns %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge bg-danger">{{ pattern.clause_type|title }}</span>
                                            <span class="badge bg-secondary">{{ pattern.count }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                                <p class="text-muted">
                                    <strong>High Risk Percentage:</strong> {{ analytics.risk_patterns.high_risk_percentage }}%
                                </p>
                            {% else %}
                                <p class="text-muted">No high-risk patterns detected.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Common Risk Factors -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Common Risk Factors
                    </h5>
                </div>
                <div class="card-body">
                    {% if analytics.risk_factors %}
                        <div class="row">
                            {% for factor in analytics.risk_factors %}
                                <div class="col-md-6 mb-3">
                                    <div class="analytics-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-1">{{ factor.factor }}</h6>
                                            <span class="badge bg-danger">{{ factor.frequency }}</span>
                                        </div>
                                        <p class="text-muted small mb-2">{{ factor.description }}</p>
                                        <span class="badge risk-level-badge risk-{{ factor.risk_level }}">
                                            {{ factor.risk_level|title }} Risk
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Great!</strong> No significant risk factors detected in the analyzed documents.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Risk Trends -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Risk Trends
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Overall Risk Trend</h6>
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge 
                                    {% if analytics.risk_trends.trend == 'increasing' %}bg-danger
                                    {% elif analytics.risk_trends.trend == 'decreasing' %}bg-success
                                    {% else %}bg-secondary{% endif %} fs-6">
                                    {{ analytics.risk_trends.trend|title }}
                                </span>
                                {% if analytics.risk_trends.trend == 'increasing' %}
                                    <i class="fas fa-arrow-up trend-indicator trend-down"></i>
                                {% elif analytics.risk_trends.trend == 'decreasing' %}
                                    <i class="fas fa-arrow-down trend-indicator trend-up"></i>
                                {% else %}
                                    <i class="fas fa-minus trend-indicator trend-stable"></i>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="analytics-card text-center">
                                        <div class="metric-value text-primary">{{ analytics.risk_trends.total_documents|default:"0" }}</div>
                                        <div class="metric-label">Documents Analyzed</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="analytics-card text-center">
                                        <div class="metric-value text-warning">{{ analytics.risk_trends.average_risk_score|default:"0" }}</div>
                                        <div class="metric-label">Avg Risk Score</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Daily Risk Averages</h6>
                            {% if analytics.risk_trends.daily_averages %}
                                <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                                    {% for date, score in analytics.risk_trends.daily_averages.items %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small>{{ date }}</small>
                                            <span class="badge 
                                                {% if score > 0.7 %}bg-danger
                                                {% elif score > 0.4 %}bg-warning
                                                {% else %}bg-success{% endif %}">
                                                {{ score }}
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No daily risk data available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Behavior Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-chart"></i> User Behavior Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>User Activity Summary</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="analytics-card text-center">
                                        <div class="metric-value text-primary">{{ analytics.user_behavior.total_actions|default:"0" }}</div>
                                        <div class="metric-label">Total Actions</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="analytics-card text-center">
                                        <div class="metric-value text-success">{{ analytics.user_behavior.active_days|default:"0" }}</div>
                                        <div class="metric-label">Active Days</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Preferred Language</h6>
                                <span class="language-badge">{{ analytics.user_behavior.preferred_language|upper }}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Feature Usage</h6>
                            {% if analytics.user_behavior.feature_usage %}
                                <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                                    {% for feature in analytics.user_behavior.feature_usage %}
                                        <div class="feature-usage-item">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong>{{ feature.feature_name|title }}</strong>
                                                <span class="badge bg-primary">{{ feature.count }}</span>
                                            </div>
                                            <div class="progress-bar-custom">
                                                <div class="progress-fill progress-success" 
                                                     style="width: {% widthratio feature.count analytics.user_behavior.total_actions 100 %}%"></div>
                                            </div>
                                            <small class="text-muted">
                                                Avg Duration: {{ feature.avg_duration|default:"0"|floatformat:2 }}ms
                                            </small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No feature usage data available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Report -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt"></i> Analytics Report
                    </h5>
                </div>
                <div class="card-body">
                    <div id="analyticsReport" class="bg-light p-3 rounded">
                        <p class="text-muted">Click "Generate Report" to view a detailed analytics report.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTimePeriod = {{ days }};
    
    // Change time period
    function changeTimePeriod() {
        const newPeriod = document.getElementById('timePeriod').value;
        if (newPeriod !== currentTimePeriod) {
            currentTimePeriod = newPeriod;
            refreshAnalytics();
        }
    }
    
    // Refresh analytics
    function refreshAnalytics() {
        location.href = `/analytics-dashboard/?days=${currentTimePeriod}`;
    }
    
    // Generate analytics report
    function generateReport() {
        const reportDiv = document.getElementById('analyticsReport');
        reportDiv.innerHTML = '<p class="text-info"><i class="fas fa-spinner fa-spin"></i> Generating report...</p>';
        
        fetch(`/api/advanced-analytics/report/?days=${currentTimePeriod}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    reportDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</p>`;
                } else {
                    reportDiv.innerHTML = `<pre class="mb-0">${data.report}</pre>`;
                }
            })
            .catch(error => {
                reportDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Failed: ${error}</p>`;
            });
    }
    
    // Utility functions
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Auto-refresh analytics every 10 minutes
    setInterval(() => {
        if (!document.hidden) {
            refreshAnalytics();
        }
    }, 600000);
</script>
{% endblock %}
